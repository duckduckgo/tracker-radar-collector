const { wait } = require('../helpers/wait');
const BaseCollector = require('./BaseCollector');

class ScreenshotCollector extends BaseCollector {

    id() {
        return 'screenshots';
    }

    /**
     * @param {import('./BaseCollector').CollectorInitOptions} options
     */
    init(options) {
        this.log = options.log;
    }

    /**
     * @param {import('puppeteer-core').CDPSession} session
     * @param {import('devtools-protocol/types/protocol').Protocol.Target.TargetInfo} targetInfo
     */
    addTarget(session, targetInfo) {
        if (targetInfo.type === 'page') {
            this._cdpClient = session;
        }
    }

    /**
     * @returns {Promise<string>}
     */
    async getData() {
        try {
            const result = await wait(
                this._cdpClient.send('Page.captureScreenshot', {format: 'jpeg', quality: 50}),
                20000,
                'Screenshot timed out',
            );
            return result.data;
        } catch (e) {
            this.log('Screenshot error', e.message);
            // return a stub error image
            return STUB_IMAGE;
        }
    }
}

const STUB_IMAGE = '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';

module.exports = ScreenshotCollector;
